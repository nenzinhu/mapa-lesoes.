<script>
const tg = window.Telegram.WebApp;
tg.expand();

let membroAtual = null;
const lesoes = {}; // { "Cabe√ßa": "Escoria√ß√£o" }

const menuTipo = document.getElementById('tipo-lesao');
const resumoDiv = document.getElementById('lista-resumo');
const textoRelato = document.getElementById('texto-relato');

// Clique no mapa
document.querySelectorAll('.membro').forEach(el => {
    el.addEventListener('click', () => {
        membroAtual = el.id.replace('_', ' ');
        menuTipo.style.display = 'block';
        menuTipo.focus();
        document.querySelectorAll('.membro').forEach(m => m.style.stroke = '#fff');
        el.style.stroke = '#0088cc';
    });
});

// Seleciona tipo da les√£o
menuTipo.addEventListener('change', () => {
    if (menuTipo.value !== "" && membroAtual) {
        lesoes[membroAtual] = menuTipo.value;
        document.getElementById(membroAtual.replace(' ', '_')).classList.add('selecionado');
        atualizarResumo();
        gerarTextoRelato();
        menuTipo.value = "";
        menuTipo.style.display = 'none';
    }
});

function atualizarResumo() {
    resumoDiv.innerHTML = "";
    for (const [local, tipo] of Object.entries(lesoes)) {
        resumoDiv.innerHTML += `<div class="item-lesao"><b>${local}:</b> ${tipo}</div>`;
    }
}

// üîπ AQUI √â O MAIS IMPORTANTE üîπ
function gerarTextoRelato() {
    let texto = "";

    for (const [local, tipo] of Object.entries(lesoes)) {

        if (tipo === "Escoria√ß√£o") {
            texto += `Foi poss√≠vel observar que a v√≠tima apresentava escoria√ß√µes aparentes na regi√£o ${local.toLowerCase()}. `;
        }
        else if (tipo === "Corte/Lacera√ß√£o") {
            texto += `Foi poss√≠vel observar les√£o aparente na regi√£o ${local.toLowerCase()}, compat√≠vel com corte. `;
        }
        else if (tipo === "Contus√£o") {
            texto += `Foi poss√≠vel observar les√£o aparente na regi√£o ${local.toLowerCase()}. `;
        }
        else if (tipo === "Queimadura") {
            texto += `Foi poss√≠vel observar les√£o aparente na regi√£o ${local.toLowerCase()}, conforme constatado no local. `;
        }
        else if (tipo === "Dor Local") {
            texto += `A v√≠tima relatava sentir dores na regi√£o ${local.toLowerCase()}. `;
        }
        else if (tipo.includes("Fratura")) {
            texto += `A v√≠tima relatava fortes dores na regi√£o ${local.toLowerCase()}, n√£o sendo poss√≠vel precisar a gravidade da les√£o. `;
        }
    }

    textoRelato.value = texto.trim();
}

function copiarRelato() {
    textoRelato.select();
    document.execCommand('copy');
    alert("Texto copiado para o relato policial.");
}

function enviarParaBot() {
    if (Object.keys(lesoes).length === 0) {
        alert("Por favor, marque ao menos uma les√£o.");
        return;
    }

    tg.sendData(textoRelato.value);
}
</script>
